<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  
  <title>Mario Maker</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bungee&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" type="text/css" href="css/style.css">
  <link rel="stylesheet" type="text/css" href="css/qf.css">

  <style>
    /* Fullscreen shell that respects safe areas */
    #stage-center {
      position: fixed;
      left: 0;
      inset: 0;
      display: block;
      width: auto;
      height: 100dvh;
      min-height: 100svh;
      z-index: 50;
    }

    /* Scaler root */
    #scale-root {
      width: auto;
      height: 30px; /* keep whatever you need here */
      transform: scale(var(--mm-scale, 1));
      transform-origin: center center;
      will-change: transform;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      backface-visibility: hidden;
      -webkit-transform: translateZ(0) scale(var(--mm-scale, 1));
    }

    /* IMPORTANT: allow pinch-zoom on the canvas, but no text selection */
    .game-screen {
      pointer-events: auto;
      touch-action: pinch-zoom; /* allow browser pinch zoom */
      -webkit-user-select: none;
      user-select: none;
    }
  </style>
</head>

<body>

  <!-- Portrait fallback overlay -->
  <div id="rotate-overlay" class="rotate-overlay" style="display:none">
    Please rotate your device to landscape for the best experience!
  </div>

  <!-- Centering shell + scalable stage -->
  <div id="scale-root">
    <div class="main-wrapper">
      <canvas class="game-screen"></canvas> 
    </div>
  </div>

  <!-- on-screen touch controls (mobile only) -->
  <div class="mobile-controls">
    <div class="nav-buttons">
      <button id="btn-left"  class="control-btn">◀</button>
      <button id="btn-right" class="control-btn">▶</button>
    </div>
    <button id="btn-jump" class="control-btn">⏫</button>
  </div>

  <!-- Scripts -->
  <script src="js/View.js"></script>
  <script src="js/GameUI.js"></script>

  <script src="js/mainGame/GameSound.js"></script>
  <script src="js/mainGame/Element.js"></script>
  <script src="js/mainGame/PowerUp.js"></script>
  <script src="js/mainGame/Enemy.js"></script>
  <script src="js/mainGame/Bullet.js"></script>
  <script src="js/mainGame/Mario.js"></script>
  <script src="js/mainGame/Score.js"></script>
  <script src="js/mainGame/MarioGame.js"></script>

  <script src="js/levelEditor/Storage.js"></script>
  <script src="js/levelEditor/Editor.js"></script>
  <script src="js/levelEditor/CreatedLevels.js"></script>

  <!-- Question Flow -->
  <script src="js/QuestionFlow.js"></script>

  <script src="js/MilestoneScreen.js"></script>

  <script src="js/MarioMaker.js"></script>

  <!-- Fit-to-screen scaler (must load before Preloader) -->
  <script src="js/Scaler.js"></script>

  <script src="js/Preloader.js"></script>

  <script>
    // Lock to landscape when allowed
    if (screen.orientation && screen.orientation.lock) {
      screen.orientation.lock('landscape').catch(function(err){
        console.warn('Orientation lock failed:', err);
      });
    }

    // Show “rotate” overlay if still in portrait on phones/tablets
    function checkOrientation() {
      const overlay = document.getElementById('rotate-overlay');
      if (window.matchMedia("(orientation: portrait) and (max-width: 1024px)").matches) {
        overlay.style.display = 'flex';
      } else {
        overlay.style.display = 'none';
      }
    }

    window.addEventListener('orientationchange', checkOrientation, { passive: true });
    window.addEventListener('resize', checkOrientation, { passive: true });
    document.addEventListener('visibilitychange', checkOrientation, { passive: true });
    checkOrientation();

    /* ===========================================================
       ALLOW PINCH-ZOOM, BLOCK SINGLE-FINGER CANVAS INPUT
       Works on both iOS (Touch Events) and Android/Chrome (Pointer Events)
       =========================================================== */
    (function pinchZoomAllowedButNoSingleTouch() {
      const canvas = document.querySelector('canvas.game-screen');
      if (!canvas) return;

      // Ensure CSS wins even if other scripts set touchAction
      canvas.style.touchAction = 'pinch-zoom';

      /* --- Pointer Events path (Chrome/Android, modern iOS) --- */
      let activeTouchPointers = new Set();

      function isTouchPointer(ev) {
        return ev && ev.pointerType === 'touch';
      }

      canvas.addEventListener('pointerdown', function(ev) {
        if (!isTouchPointer(ev)) return;
        activeTouchPointers.add(ev.pointerId);
        // Do NOT prevent default here, so a second finger can join to start a pinch
      }, { passive: true });

      canvas.addEventListener('pointermove', function(ev) {
        if (!isTouchPointer(ev)) return;
        // If exactly one finger is on the canvas, block its move so the game can't read it.
        if (activeTouchPointers.size === 1) {
          ev.preventDefault();
          ev.stopPropagation();
        }
      }, { capture: true, passive: false });

      function endPointer(ev) {
        if (!isTouchPointer(ev)) return;
        activeTouchPointers.delete(ev.pointerId);
      }
      canvas.addEventListener('pointerup', endPointer, { passive: true, capture: true });
      canvas.addEventListener('pointercancel', endPointer, { passive: true, capture: true });

      /* --- Touch Events path (iOS Safari) --- */
      canvas.addEventListener('touchstart', function(ev) {
        // Don't block; allow a second finger to join for pinch
      }, { passive: true });

      canvas.addEventListener('touchmove', function(ev) {
        // Let two+ fingers do pinch zoom
        if (ev.touches && ev.touches.length >= 2) return;
        // Single-finger move: block so gameplay doesn't react to swipes/taps on canvas
        ev.preventDefault();
        ev.stopPropagation();
      }, { capture: true, passive: false });

      canvas.addEventListener('touchend', function(ev) {
        // nothing special; keep default so pinch can settle
      }, { passive: true, capture: true });

      // Optional: block click synthesis on the canvas (from taps), just in case
      canvas.addEventListener('click', function(ev) {
        ev.stopPropagation();
        // no preventDefault so links outside still work after zoom
      }, { capture: true });

    })();
  </script>

</body>
</html>
